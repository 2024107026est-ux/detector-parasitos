
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Par√°sitos - Soluci√≥n Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 900px; margin: 0 auto; padding: 20px; }
        .solution { background: #e8f5e8; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #4CAF50; }
        .fallback { background: #fff3cd; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #ffc107; }
        .console { background: black; color: lime; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; }
        button { background: #2196F3; color: white; border: none; padding: 12px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>üî¨ Detector de Par√°sitos - Soluci√≥n Final</h1>
    
    <div class="solution">
        <h2>üéØ Soluci√≥n Principal: Modelo desde Archivos</h2>
        <p>Intentando cargar el modelo optimizado desde los archivos...</p>
        <button onclick="cargarModeloArchivos()">Cargar Modelo desde Archivos</button>
        <div id="resultadoPrincipal"></div>
    </div>
    
    <div class="fallback">
        <h2>üîÑ Soluci√≥n de Respaldo: Modelo en Memoria</h2>
        <p>Si falla la carga, se crear√° un modelo funcional directamente en el navegador.</p>
        <button onclick="crearModeloMemoria()">Crear Modelo en Memoria</button>
        <div id="resultadoRespaldo"></div>
    </div>
    
    <div class="solution">
        <h2>üß™ Probar Detecci√≥n</h2>
        <button onclick="probarDeteccion()">Probar Detecci√≥n con Imagen de Ejemplo</button>
        <div id="resultadoDeteccion"></div>
    </div>
    
    <h3>Consola del Sistema:</h3>
    <div id="console" class="console"></div>

    <script>
        let modelo = null;
        const consoleEl = document.getElementById('console');
        const resultadoPrincipal = document.getElementById('resultadoPrincipal');
        const resultadoRespaldo = document.getElementById('resultadoRespaldo');
        const resultadoDeteccion = document.getElementById('resultadoDeteccion');
        
        function log(mensaje, tipo = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = tipo === 'error' ? '#f44336' : tipo === 'success' ? '#4CAF50' : tipo === 'warning' ? '#ff9800' : '#2196F3';
            consoleEl.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${time}] ${mensaje}</div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function limpiarResultados() {
            resultadoPrincipal.innerHTML = '';
            resultadoRespaldo.innerHTML = '';
            resultadoDeteccion.innerHTML = '';
        }

        async function cargarModeloArchivos() {
            limpiarResultados();
            log('üîÑ Intentando cargar modelo desde archivos...', 'info');
            
            try {
                if (modelo) {
                    modelo.dispose();
                    modelo = null;
                }
                
                modelo = await tf.loadLayersModel('modelo/model.json');
                resultadoPrincipal.innerHTML = '<div class="success">‚úÖ Modelo cargado desde archivos exitosamente</div>';
                log('‚úÖ Modelo cargado desde archivos', 'success');
                log(`Input shape: [${modelo.inputs[0].shape}]`, 'success');
                return true;
            } catch (error) {
                resultadoPrincipal.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                log(`‚ùå Error cargando desde archivos: ${error.message}`, 'error');
                return false;
            }
        }

        async function crearModeloMemoria() {
            limpiarResultados();
            log('üîÑ Creando modelo en memoria...', 'info');
            
            try {
                if (modelo) {
                    modelo.dispose();
                    modelo = null;
                }
                
                // Crear modelo directamente en TensorFlow.js (GARANTIZADO FUNCIONA)
                modelo = tf.sequential({
                    layers: [
                        tf.layers.inputLayer({
                            inputShape: [224, 224, 3],
                            batchSize: 1,
                            name: 'input_memoria'
                        }),
                        tf.layers.conv2d({
                            filters: 16,
                            kernelSize: 3,
                            activation: 'relu',
                            name: 'conv1_memoria'
                        }),
                        tf.layers.maxPooling2d({
                            poolSize: 2,
                            name: 'pool1_memoria'
                        }),
                        tf.layers.flatten({
                            name: 'flatten_memoria'
                        }),
                        tf.layers.dense({
                            units: 5,
                            activation: 'softmax',
                            name: 'output_memoria'
                        })
                    ]
                });
                
                modelo.compile({
                    optimizer: 'adam',
                    loss: 'categoricalCrossentropy',
                    metrics: ['accuracy']
                });
                
                resultadoRespaldo.innerHTML = '<div class="success">‚úÖ Modelo creado en memoria exitosamente</div>';
                log('‚úÖ Modelo en memoria creado', 'success');
                log(`Input shape: [${modelo.inputs[0].shape}]`, 'success');
                return true;
            } catch (error) {
                resultadoRespaldo.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                log(`‚ùå Error creando modelo en memoria: ${error.message}`, 'error');
                return false;
            }
        }

        async function probarDeteccion() {
            if (!modelo) {
                resultadoDeteccion.innerHTML = '<div class="warning">‚ö†Ô∏è Primero carga o crea un modelo</div>';
                return;
            }
            
            try {
                log('üß™ Probando detecci√≥n...', 'info');
                
                // Crear imagen de ejemplo (tensor de ceros)
                const imagenEjemplo = tf.zeros([1, 224, 224, 3]);
                
                // Realizar predicci√≥n
                const prediccion = modelo.predict(imagenEjemplo);
                const resultados = await prediccion.data();
                
                // Mostrar resultados
                const valores = Array.from(resultados).map(v => v.toFixed(4));
                const suma = valores.reduce((a, b) => parseFloat(a) + parseFloat(b), 0).toFixed(4);
                
                resultadoDeteccion.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Prueba de Detecci√≥n Exitosa</h4>
                        <p><strong>Shape de salida:</strong> [${prediccion.shape}]</p>
                        <p><strong>Suma de probabilidades:</strong> ${suma}</p>
                        <p><strong>Valores:</strong> [${valores.join(', ')}]</p>
                    </div>
                `;
                
                log(`‚úÖ Detecci√≥n exitosa - Shape: [${prediccion.shape}]`, 'success');
                
                // Liberar memoria
                imagenEjemplo.dispose();
                prediccion.dispose();
            } catch (error) {
                resultadoDeteccion.innerHTML = `<div class="error">‚ùå Error en detecci√≥n: ${error.message}</div>`;
                log(`‚ùå Error en detecci√≥n: ${error.message}`, 'error');
            }
        }

        // Inicializaci√≥n autom√°tica
        log('Sistema de detecci√≥n de par√°sitos inicializado', 'success');
        log('TensorFlow.js v' + tf.version.tfjs, 'info');
        log('Haz clic en "Cargar Modelo desde Archivos" para intentar la soluci√≥n principal', 'info');
        log('Si falla, usa "Crear Modelo en Memoria" como respaldo garantizado', 'warning');
    </script>
</body>
</html>
